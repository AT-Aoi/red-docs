= Red/View 图形引擎（Red/View Graphic Engine）
:imagesdir: ../images
:toc:
:toclevels: 3
:toc-title: 目录
:numbered:

== 设计目标（Design goals）

Red/View (或称 View) 组件是 Red 编程语言的图形系统。其设计目标为：

* 面向数据的极简 API
* 以虚拟对象树作为编程接口
* 显示系统与虚拟树之间实时或延迟的同步
* 让双向绑定的支持可以轻松实现
* 拥有不同的后端并且跨平台的能力
* 支持操作系统的、第三方的以及自定义的部件集
* 低性能开销

虚拟树是用元件（face）对象构建起来的，每个元件对象都以双向绑定映射到一个在显示器上的图形组件。

== 元件对象（Face object）

元件对象是 `face!` 模板对象的拷贝，一个在元件对象中的字段被称作 _特征_ （facet）。

可用特征的清单：

[cols="1,1,1,1,2", options="header"]
|===

|特征    | 数据类型        | 强制性？ | 适用性 | 描述
|type    | word!           | 是       | 所有   | 图形组件的类型（参考 link:view.html#face-types[下面]）。
|offset  | pair!           | 是       | 所有   | 相对与父元件左上角原点的偏移量。
|size    | pair!           | 是       | 所有   | 该元件的大小。
|text    | string!         | 否       | 所有   | 显示在该元件上的标签文本。
|image   | image!          | 否       | 某些   | 显示在该元件背景的图片。
|color   | tuple!          | 否       | 某些   | 该元件的背景颜色，格式为 R.G.B 或 R.G.B.A。
|menu    | block!          | 否       | 所有   | 菜单栏或上下文菜单。
|data    | any-type!       | 否       | 所有   | 该元件的内容数据。
|enabled?| logic!          | 是       | 所有   | 启用或禁用在该元件上的输入事件。
|visible?| logic!          | 是       | 所有   | 显示或隐藏该元件。
|selected| integer!        | 否       | 某些   | 当前选中的元素的索引，用于列表类型。
|flags   | block!, word!   | 否       | 某些   | 改变该元件的显示或行为的特殊的关键字列表。
|options | block!          | 否       | 某些   | 额外的元件属性，格式为 [name: value]。
|parent  | object!         | 否       | 所有   | 对父元件的反向引用（如果有的话）。
|pane    | block!          | 否       | 某些   | 显示在该元件内部的子元件的列表。
|state   | block!          | 否       | 所有   | 内部的元件状态的信息 *（仅被 View 引擎使用）*。
|rate    | integer!, time! | 否       | 所有   | 元件的计时器。使用整数设置频率，使用时间设置时长，使用无来停止它。
|edge    | object!         | 否       | 所有   | *（保留以在将来使用）*。
|para    | object!         | 否       | 所有   | 用于定位文本的 Para 对象的引用。
|font    | object!         | 否       | 所有   | 用于设置元件的字体属性的 Font 对象的引用。
|actors  | object!         | 否       | 所有   | 用户提供的事件处理器。
|extra   | any-type!       | 否       | 所有   | 附加于该元件上的可选的用户数据（用法自由）。
|draw    | block!          | 否       | 所有   | 要画在元件上的 Draw 命令的列表。
|===

`flags` 特征的全局可用标记的清单：

[cols="1,4", options="header"]
|===
|标记      | 描述
|*all-over*| 向该元件发送所有的 `over` 事件。
|===

其他特定于元件类型的标记记录在其各自的小节中。

[NOTE]
====
* 非强制性特征可以设置为 `none`。
* `offset` 和 `size` 以屏幕像素为单位指定。
* `offset` 和 `size` 在它们被显示之前有时可以设置 `none`，View 引擎将负责设置这些值（像在 tab-panel 类型里的 panel 那样).
* 显示顺序（从后往前）：color、image、text、draw.
====

创建新的元件要通过拷贝 `face!` 对象，并 *至少* 提供一个有效的 `type` 名称来达成。

    button: make face! [type: 'button]

一旦元件被创建，其 `type` 字段就不允许再被更改。

=== 选项特征（Options facet）

选项特征持有可选的用于特定的行为的特征：

[cols="1,4" options="header"]
|===
|选项           | 描述
|*drag&#8209;on*| 可以是其中之一：`'down`、`'mid-down`、`'alt-down`、`'aux-down`。用于启用拖拽操作。
|===

== 字体对象（Font object）

字体对象是 `font!` 模板对象的拷贝。一个字体对象可以被一个或多个元件引用，这使从单个地方控制一组元件的字体属性成为可能。

[cols="1,1,1,3", options="header"]
|===
|字段       | 数据类型     | 强制性?| 描述
|name       | string!      | 否     | 安装在操作系统上的有效的字体名称。
|size       | integer!     | 否     | 字体大小，以磅为单位。
|style      | word!, block!| 否     | 样式模式或样式模式区块。
|angle      | integer!     | 是     | 文本书写角，以角度为单位（默认为 `0`）。
|color      | tuple!       | 是     | 文本颜色，格式为 R.G.B 或 R.G.B.A。
|anti-alias?| logic!, word!| 否     | 反锯齿模式（激活/非激活或特殊模式）。
|shadow     | *（保留）*   | 否     | *（保留以在将来使用）*
|state      | block!       | 否     | 内部的元件状态信息 *（仅被 View 引擎使用）*。
|parent     | block!       | 否     | 内部的对父元件（可多个）的反向引用 *（仅被 View 引擎使用）*。
|===

[NOTE]
====
* 非强制性特征可以被设置为 `none`。
* `angle` 字段还不能正常工作。
* 所有字段的值将来都应会变成可选的。
====

可用的字体样式：

* `bold`
* `italic`
* `underline`
* `strike`

可用的抗锯齿模式：

* 激活/非激活（`anti-alias?: yes/no`）
* ClearType 模式（`anti-alias?: 'ClearType`）

== 段落对象（Para object）

段落对象是 `para!` 模板对象的拷贝。一个段落对象可以被一个或多个元件引用，这使从单个地方控制一组元件的段落属性成为可能。

[cols="1,1,3" options="header"]
|===
|字段   | 数据类型| 描述

|origin | *保留*  | *（保留以在将来使用）*
|padding| *保留*  | *（保留以在将来使用）*
|scroll | *保留*  | *（保留以在将来使用）*
|align  | word!   | 控制文本水平对齐：`left`、`center`、`right`。
|v-align| *保留*  | 控制文本垂直对齐：`top`、`middle`、`bottom`。
|wrap?  | logic!  | 启用/禁用在元件中的文本自动换行。
|parent | block!  | 内部的对父元件（可多个）的反向引用。 *（仅被 View 引擎使用）*。
|===

[NOTE]
====
* 任何段落的字段都可以设置为 `none`。
====

== 元件树（The face tree）

元件组织在一棵树中，这棵树会映射到显示器上的图形组件层级。树的关系定义为：

* `pane` 特征：区块形式的内含一个或多个子元件的列表。
* `parent` 特征：对父元件的引用。

元件对象在 `pane` 中的顺序的有关系的，它映射到图形对象的 Z 轴次序（在 `pane` 的头部的元件显示在所有其他元件的后面，在尾部的元件显示在所有对象的顶部）。

元件树的根是 `screen` 元件，`screen` 元件只能显示其 `pane` 区块里的 `window` 元件。

要让任何元件在屏幕上显示出来，它都 *必须* 直接地（对于窗口来说）或间接地（对于其他元件类型来说）连接到 `screen` 元件。

image::face-tree.png[Face tree,align="center"]

[#face-types]
== 元件类型（Face types）

=== Base（基元件）

`base` 类型是最基本的元件类型，但它也是最全能的一种元件类型。它默认只显示一个颜色为 `128.128.128` 的背景。

[cols="1,3", options="header"]
|===
|特征   | 描述
|`type` | `'base`
|`image`| 可以指定 `image!` 值，它支持透明通道。
|`color`| 可以指定背景颜色，它支持透明通道。
|`text` | 显示在元件内部的可选的文本。
|`draw` | Draw 原语完全支持透明度。
|===

[NOTE]
====
* 支持以下特征的全组合，并会以以下顺序渲染：`color`、`image`、`text`、`draw`。
* 可以在 `color`、`image`、`text` 和 `draw` 中指定颜色元组值中的一个透明通道分量来达到透明效果：`R.G.B.A`，其中 `A = 0` 表示完全不透明，`A = 255`，表示完全透明。
====

*该元件类型应该被用于所有的自定义图形组件的实现。*

'''

=== Text（文本）

`text` 类型是用于显示的静态标签。

[cols="1,3", options="header"]
|===
|特征     | 描述 

|`type`   | `'text`
|`text`   | 标签文本。
|`data`   | 以文本显示的值。
|`options`| 支持的字段：`default`。
|===

`data` 特征与 `text` 元件使用以下转换规则实时同步：

* 当 `text` 变化时，`data` 会被设置为 `load` 过的 `text` 值或 `none`，或如果有定义 `options/default`，也可能被设置为该值。
* 当 `data` 变化时，`text` 会被设置为 `form` 过的 `data` 值。

`options` 特征接受以下属性：

* `default`：可以被设置为任何值，比如无法加载的字符串，如果转换 `text` 返回 `none`，它将被该 `data` 特征使用。

'''

=== Button（按钮）

该类型代表简单的按钮。

[cols="1,4", options="header"]
|===
|元件   | 描述
|`type` | `'button`
|`text` | 按钮的标签文本。
|`image`| 该图片会被显示在按钮内部，它可以与文本一起使用。
|===

[cols="1,1,3", options="header"]
|===

|事件类型| 处理器    | 描述

|`click` | `on-click`| 当用户在按钮上点击时触发。
|===

=== Check（复选框）

该类型代表复选框，它带有可选的标签文本，文本显示在左侧或右侧。

[cols="1, 4", options="header"]
|===
|特征  | 描述

|`type`| `'check`
|`text`| 标签文本。
|`para`| `align` 字段控制该文本是靠 `left` 边显示还是靠 `right` 边显示。
|`data`| `true`：被选中的；`false`；未被选中的（默认）。
|===

[cols="1, 1, 3", options="header"]
|===
|事件类型| 处理器     | 描述
|`change`| `on-change`| 当该复选框的状态被用户动作更改时触发。
|===


=== Radio（单选框）

该类型代表单选按钮，它带有可选的标签文本，文本显示在左侧或右侧。每个窗格中只能有一个单选按钮被选中。

[cols="1, 4", options="header"]
|===

|特征  | 描述
|`type`| `'radio`
|`text`| 标签文本。
|`para`| `align` 字段控制该文本是靠 `left` 边显示还是靠 `right` 边显示。
|`data`| `true`：被选中的；`false`；未被选中的（默认）。
|===

[cols="1,1,3", options="header"]
|===
|事件类型| 处理器     | 描述
|`change`| `on-change`| 当该单选框的状态被一个用户动作更改时触发。
|===

=== Field（文本域）

该类型代表单行输入文本域。

[cols="1, 4", options="header"]
|===
|特征     | 描述
|`type`   | `'field`
|`text`   | 输入文本；为可读/写值。
|`data`   | 以文本显示的值。
|`options`| 支持的字段：`default`。
|`flags`  | 开启/关闭某些特殊的文本域特性（block!）。
|===

*支持的标记：*

* `no-border`：删除由底层 GUI 框架创建的边缘装饰。

`data` 特征与 `text` 特征使用以下转换规则实时同步：

* 当 `text` 变化时，`data` 会被设置为 `load` 过的 `text` 值或 `none`，或如果有定义 `options/default`，也可能被设置为该值。
* 当 `data` 变化时，`text` 会被设置为 `form` 过的 `data` 值。

`options` 元件接收以下属性：

* `default`：可以被设置为任何值，比如无法加载的字符串，如果转换 `text` 返回 `none`，它将被该 `data` 特征使用。

[NOTE]
====
* `selected` 将来会用于控制的输入文本的高亮部分。
====

[cols="1, 1, 3", options="header"]
|===

|事件类型| 处理器     | 描述
|`enter` | `on-enter` | 每次在该文本域中按下回车键时发生。
|`change`| `on-change`| 每次在该文本域中造成一个输入时发生。
|`key`   | `on-key`   | 每次在该文本域中按下一个键时发生。
|===

=== Area（文本区域）

该类型代表多行输入域。

[cols="1, 4", options="header"]
|===
|特征   | 描述
|`type` | `'area`
|`text` | 输入文本；为可读/写值。
|`flags`| 开启/关闭某些特殊的文本区域特性（block!）。
|===

*支持的标记：*

* `no-border`：删除由底层 GUI 框架创建的边框装饰。

[NOTE]
====
* `selected` 将来会用于控制的输入文本的高亮部分。
* 如果文本行在该文本区域中不是所有都可见的，则会出现垂直滚动条（大概将来会由的某个 `flags` 选项来控制）。
====

[cols="1, 1, 2", options="header"]
|===
|事件类型| 处理器     | 描述
|`change`| `on-change`| 每次在该文本区域中造成一个输入时发生。
|`key`   | `on-key`   | 每次在该文本区域中按下一个键时发生。
|===

'''

=== Text-list（文本列表）

该类型代表含有一组文本字符串的垂直列表，它显示在固定的框架中。如果内容大小不符合框架，则会自动出现垂直滚动条。

[cols="1, 4", options="header"]
|===
|特征      | 描述
|`type`    | `'text-list`
|`data`    | 要显示的字符串列表（block! hash!）。
|`selected`| 选定的字符串的索引，或若未选择，则为无值。（可读/写）
|===

[cols="1, 1, 3", options="header"]
|===

|事件类型| 处理器     | 描述
|`select`| `on-select`| 当该列表中的条目被选定时发生。`selected` 特征指向 *旧的* 被选定的条目的索引。
|`change`| `on-change`| 在 `selected` 事件之后发生。`selected` 特征指向这个 *新的* 被选定的条目的索引。
|===

[NOTE]
====
* 现在用户还不能定义可见项目的数量。
====

=== Drop-list（下拉列表）

该类型表示含有一组文本字符串的垂直列表，它显示在可折叠的框架中。如果内容大小不符合框架，则会自动出现垂直滚动条。

[cols="1, 4", options="header"]
|===

|特征      | 描述

|`type`    | `'drop-list`
|`data`    | 要显示的字符串列表（block! hash!）。
|`selected`| 选定的字符串的索引，或若未选择，则为无值。（可读/写）
|===

`data` 特征可接收任意值，但只有字符串值才会被添加到该列表中并显示，可以以字符串作为键，使用额外的非字符串数据类型的值来创建关联数组。`selected` 特征是基于 1 的整数索引，它表示在该列表中所选字符串的位置，而不是在 `data` 特征中的位置。

[cols="1, 1, 3", options="header"]
|===

|事件类型| 处理器     | 描述
|`select`| `on-select`| 当该列表中的条目被选定时发生。`selected` 特征指向 *旧的* 被选定的条目的索引。
|`change`| `on-change`| 在 `selected` 事件之后发生。`selected` 特征指向这个 *新的* 被选定的条目的索引。
|===

[NOTE]
====
* 现在用户还不能定义可见项目的数量。
====

=== Drop-down（下拉域）

该类型表示含有一组文本字符串的垂直列表的文本域，它显示在可折叠的框架中。如果内容大小不符合框架，则会自动出现垂直滚动条。

[cols="1, 4", options="header"]
|===
|特征      | 描述
|`type`    | `'drop-down`
|`data`    | 要显示的字符串列表（block! hash!）。
|`selected`| 选定的字符串的索引，或若未选择，则为无值。（可读/写）
|===

`data` 特征可接收任意值，但只有字符串值才会被添加到该列表中并显示，可以以字符串作为键，使用额外的非字符串数据类型的值来创建关联数组。`selected` 特征是基于 1 的整数索引，它表示在该列表中所选字符串的位置，而不是在 `data` 特征中的位置。

[cols="1, 1, 3", options="header"]
|===

|事件类型| 处理器     | 描述
|`select`| `on-select`| 当该列表中的条目被选定时发生。`selected` 特征指向 *旧的* 被选定的条目的索引。
|`change`| `on-change`| 在 `selected` 事件之后发生。`selected` 特征指向这个 *新的* 被选定的条目的索引。
|===

[NOTE]
====
* 现在用户还不能定义可见项目的数量。
====

=== Progress（进度条）

该类型代表水平的或垂直的进度条。

[cols="1, 4", options="header"]
|===

|特征  | 描述
|`type`| `'progress`
|`data`| 代表进度的值（percent! 或 float! 值）。
|===

[NOTE]
====
* 如果把浮点数值用于 `data`，它需要在 0.0 到 1.0 之间。
====

=== Slider（滑块）

该类型代表可沿水平轴或垂直轴移动的光标。

[cols="1, 4", options="header"]
|===
|特征  | 描述
|`type`| `'slider`
|`data`| 代表光标位置的值（percent! 或 float! 值）。
|===

[NOTE]
====
* 如果把浮点数值用于 `data`，它需要在 0.0 到 1.0 之间。
====

=== Camera（相机）

该类型用于显示相机提要。

[cols="1, 4", options="header"]
|===
|特征      | 描述
|`type`    | `'camera`
|`data`    | 区块形式的内含相机（可多个）的列表。
|`selected`| 用一个整数索引从 `data` 列表中选择要显示的相机，如果设为 `none`，则禁用相机提要。
|===

[NOTE]
====
* `data` 特征最初会被设置为 `none`，这个内含相机的列表会在第一次以该相机元件为参数调用 `show` 时被取得。
* 可以以该元件为参数调用 `to-image` 来捕捉相机元件的内容。
====

=== Panel（面板）

面板是其他元件的容器。

[cols="1, 4", options="header"]
|===

|特征  | 描述
|`type`| `'panel`
|`pane`| 内含子元件的区块，区块中的顺序定义了在显示器上的 Z 轴次序。
|===

[NOTE]
====
* 子元件 `offset` 坐标相对于父面板的左上角。
* 子元件会被裁剪以适应该面板的框架。
====

'''

=== Tab-panel（选项卡面板）

选项卡面板一组面板的列表，它在一个给定时刻只有一个面板可见。面板名称列表作为“选项卡”显示，它用于切换面板。

[cols="1, 4", options="header"]
|===
|特征      | 描述
|`type`    | `'tab-panel`
|`data`    | 内含选项卡名字的区块（字符串值）。
|`pane`    | 内含面板的列表，对应于选项卡列表（`block!`）。
|`selected`| 所选面板的索引，或无值（`integer!`）（可读/写）。
|===

[cols="1, 1, 3", options="header"]
|===
|事件类型| 处理器   | 描述
|`change`| on-change| 当用户选择一个新的面板时发生。`event/picked` 持有该新选定的选项卡的索引。`selected` 属性会在这个事件刚结束后被更新。
|===

[NOTE]
====
* `data` 和 `pane` 两个特征都要填写，以正常显示选项卡面板。
* 如果 `pane` 包含比指定的选项卡更多的面板，它们将被忽略。
* 添加/删除选项卡时，相应的面板需要添加到 `pane` 列表/从 `pane` 列表中删除。
====

=== Window（窗口）

代表操作系统桌面上显示的窗口。

[cols="1, 4", options="header"]
|===
|特征      | 描述
|`type`    | `'window`
|`text`    | 该窗口的标题（`string!`）。
|`offset`  | 相对于桌面屏幕左上角的偏移量，不把该窗口的边框装饰计算在内。（`pair!`）。
|`size`    | 该窗口的大小，不把该窗口的边框装饰计算在内（`pair!`）。
|`flags`   | 开启/关闭某些特殊的窗口特性（`block`）。
|`menu`    | 在该窗口里显示菜单栏（`block`）。
|`pane`    | 要在该窗口内部显示的元件列表（`block!`）。
|`selected`| 选择将会获得焦点的元件（`object`）。
|===

*支持的标记：*

* `modal`：使窗口变成模态，禁用所有之前打开的窗口。
* `resize`：启用窗口缩放（默认是固定大小，不是可缩放的）。
* `no-title`：不显示窗口标题文本。
* `no-border`：删除窗口的边框装饰。
* `no-min`：删除窗口的标题栏中的最小化按钮。
* `no-max`：删除窗口的标题栏中的最大化按钮。
* `no-buttons`：删除窗口的标题栏中的所有按钮。
* `popup`: 另一种更小的边框装饰（仅支持 Windows）。

[NOTE]
====
* 在使用菜单规格区块的开头使用 `popup` 关键字将强制使用窗口中的上下文菜单而不是默认情况下的菜单栏。
====

=== Screen（屏幕）

代表连接到该计算机的图形显示单元（通常为显示器）。

[cols="1, 4", options="header"]
|===
|特征  | 描述
|`type`| `'screen`
|`size`| 该显示屏幕的大小，在 View 引擎启动时被设置（`pair!`）。
|`pane`| 要显示在屏幕上的内含窗口的列表（`block!`）。
|===

所有显示的元件都需要是屏幕元件的子元件。

=== Group-box（编组框）

编组框是其他元件的容器，周围有可见的边框，*这是临时的样式，一旦我们有了对 `edge` 特征的支持它就会被移除*。

[cols="1, 4", options="header"]
|===
|特征  | 描述
|`type`| `'group-box`
|`pane`| 内含子元件的区块，区块中的顺序定义了在显示器上的 Z 轴次序。
|===

[NOTE]
====
* 子元件 `offset` 坐标相对于编组框的左上角。
* 子元件会被裁剪以适应该编组框的框架。
====

== 元件生命周期（Face life cycle）

. 从 `face!` 原型创建一个元件对象。
. 将元件对象插入到与屏幕元件相连的元件树中。
. 使用 `show` 在屏幕上渲染元件对象。
.. 此时系统资源被分配。
.. `face/state` 区块被设置。
. 从窗格中删除元件以将其从显示器上移除。
. 垃圾收集器将负责在元件不再被引用时释放相关的系统资源。

[NOTE]
====
* 之后可能会提供 `free` 函数用于为消耗大量资源的应用程序手动控制系统资源的释放。
====

== SHOW 函数（SHOW function）

*语法*

----
show <face>

<face>: face! 对象的拷贝，或内含元件对象或名称（使用 word! 值）的区块.
----

*描述*

该功能用于更新屏幕上的元件或内含元件的列表，只有在连接到屏幕元件的元件树中被引用的元件才能正常地渲染到屏幕上。当第一次调用时，将分配系统资源，设置`state` 特征，将该图形组件显示在屏幕上，随后的调用会在屏幕上反映对元件对象所做的任何更改。如果有定义 `pane` 特征，那么 `show` 也会递归地应用于其子元件

*状态特征*

*以下提供信息仅供参考。在正常操作中，用户不应该动 `state` 特征，然而，如果用户要直接调用 OS API 或者要需要修改 View 引擎的行为，则可以访问它。*

[cols="1, 4", options="header"]
|===
|位置/字段      | 描述
|1 (handle)     | 该图形对象的特定于操作系统的句柄（`integer!`）。
|2 (changes)    | 位元标记数组，用来标记从最后一次对 `show` 的调用起哪个特性被改变过（`integer!`）。
|3 (deferred)   | 当关闭实时更新时，内含从最后一次对 `show` 的调用起的延迟变化的列表（`block!` `none!`）。
|4 (drag-offset)| 存储当进入元件拖拽模式时起始鼠标指针的偏移位置（`pair!` `none!`）。
|===

[NOTE]
====
* 在调用 `show` 后，`changes` 字段会被重置为 0，`deferred` 字段区块会被清空。
* 将来会用 `handle!` 数据类型来处理不透明操作系统句柄。
====

== 实时vs延期更新 anchor:realtime-vs-deferred-updating[]

View引擎有两种不同的模式用于在face树完成更改后更新显示：

* 实时更新：任何face变化都会立即显示在屏幕上。

* 延期更新：对脸部的所有更改都不会在屏幕上传播，直到在face或父face上调用`show`。

这些模式之间的切换由`system/view/auto-sync`字控制：如果设置为`yes`，则实时更新模式为（默认模式），如果设置为`no`，则View引擎将延迟 所有更新。

默认情况下实时更新的动机有：

* 更简单和更短的源代码，无需在任何改变后调用`show`。
* 初学者的学习开销较少
* 足够简单或原型应用程序。
* 简化控制台的实验。

延迟模式在屏幕上同时更新许多更改，以避免毛刺或达到最佳性能目标。

注意：

* 这与只有延迟模式支持的Rebol/View引擎有很大的区别。

== 双向绑定

面对对象依靠Red所有权系统将对象与face中使用的系列绑定在一起，使face对象检测到任何一个方面（即使是深刻变化）的任何变化，并根据当前的同步模式(实时或延期）进行处理。

另一方面，对渲染图形对象进行的更改会立即反映在相应的方面。 例如，键入`field` face将在实时模式下反映`text` facet的输入。

这种双向绑定简化了与程序员的图形对象的交互，而不需要任何特定的API。 使用系列动作修改方面就足够了。

例子：
----
view [
    list: text-list data ["John" "Bob" "Alice"]
    button "Add" [append list/data "Sue"]
    button "Change" [lowercase pick list/data list/selected]
]
----
== Events 

=== 事件名 

[cols="1, 1, 3", options="header"]
|===

|Name| Input type| Cause
|*down*| mouse| Left mouse button pressed.	
|*up*| mouse| Left mouse button released.
|*mid&#8209;down*| mouse| Middle mouse button pressed.
|*mid&#8209;up*| mouse| Middle mouse button released.
|*alt&#8209;down*| mouse| Right mouse button pressed.
|*alt&#8209;up*| mouse| Right mouse button released.
|*aux&#8209;down*| mouse| Auxiliary mouse button pressed.
|*aux&#8209;up*|	mouse| Auxiliary mouse button released.
|*drag&#8209;start*| mouse| A face dragging starts.
|*drag*| mouse| A face is being dragged.
|*drop*| mouse| A dragged face has been dropped.
|*click*| mouse| Left mouse click (button widgets only).
|*dbl&#8209;click*| mouse| Left mouse double-click.
|*over*| mouse| Mouse cursor passing over a face. This event is produced once when the mouse enters the face and once when it exits. If `flags` facet contains *all&#8209;over* flag, then all intermediary events are produced too.
|*move*|	mouse| A window has moved.
|*resize*| mouse| A window has been resized.
|*moving*| mouse| A window is being moved.
|*resizing*| mouse| A window is being resized.
|*wheel*| mouse| The mouse wheel is being moved.
|*zoom*|	touch| A zooming gesture (pinching) has been recognized.
|*pan*| touch| A panning gesture (sweeping) has been recognized.
|*rotate*| touch| A panning gesture (sweeping) has been recognized.
|*two&#8209;tap*| touch| A double tapping gesture has been recognized.
|*press&#8209;tap*| touch| A press-and-tap gesture has been recognized.
|*key&#8209;down*| keyboard| A key is pressed down.
|*key*| keyboard| A character was input or a special key has been pressed (except control; shift and menu keys).
|*key&#8209;up*| keyboard| A pressed key is released.
|*enter*| keyboard| Enter key is pressed down.
|*focus*| any| A face just got the focus.
|*unfocus*| any| A face just lost the focus.
|*select*| any| A selection is made in a face with multiple choices.
|*change*| any| A change occurred in a face accepting user inputs (text input or selection in a list).
|*menu*| any| A menu entry is picked.
|*close*| any| A window is closing.
|*time*| timer| The delay set by face's `rate` facet expired.
|===

注意：

* 触摸事件不适用于Windows XP。
* 一个或多个`moving`事件总是在`move`之前。
* 一个或多个`resize`事件总是在`resize`之前。

=== Event!数据类型

事件值是一个不透明的对象，保存有关给定事件的所有信息。 您可以使用路径符号访问事件字段。

[cols="1, 4", options="header"]
|===
|Field| Returned value
|`type`| Event type (word!).
|`face`| Face object where the event occurred (object!).
|`window`| Window face where the event occured (object!).
|`offset`| Offset of mouse cursor relative to the face object when the event occurred (pair!). For gestures events, returns the center point coordinates.
|`key`| Key pressed (char! word!).
|`picked`| New item selected in a face (integer! percent!). For `wheel` event, it returns the number of rotation steps. A positive value indicates that the wheel was rotated forward, away from the user; a negative value indicates that the wheel was rotated backward, toward the user. For `menu` event, it returns the corresponding menu ID (word!). For zooming gesture, it returns a percent value representing the relative increase/decrease. For other gestures, its value is system-dependent for now (Windows: `ullArguments`, field from https://msdn.microsoft.com/en-us/library/windows/desktop/dd353232(v=vs.85).aspx[GESTUREINFO]).
|`flags`| Returns a list of one or more flags (see list below) (block!).
|`away?`| Returns `true` if the mouse cursor exits the face boundaries (logic!). Applies only if `over` event is active. 
|`down?`| Returns `true` if the mouse left button was pressed (logic!).
|`mid-down?`| Returns `true` if the mouse middle button was pressed (logic!).
|`alt-down?`| Returns `true` if the mouse right button was pressed (logic!).
|`ctrl?`| Returns `true` if the CTRL key was pressed (logic!).
|`shift?`| Returns `true` if the SHIFT key was pressed (logic!).
|===

来自`event/flags`的可能标志的列表：

* `away`
* `down`
* `mid-down`
* `alt-down`
* `aux-down`
* `control`
* `shift`

注意：

* 所有字段（`type`除外）都是只读的。 设置`type`仅由View引擎内部使用。

这里是由`event/key`作为单词返回的特殊键的列表：

* `page-up`
* `page-down`
* `end`
* `home`
* `left`
* `up`
* `right`
* `down`
* `insert`
* `delete`
* `F1`
* `F2`
* `F3`
* `F4`
* `F5`
* `F6`
* `F7`
* `F8`
* `F9`
* `F10`
* `F11`
* `F12`

只有`key-down`和`key-up`消息可以通过`event/key`返回以下额外的密钥名称：

* `left-control`
* `right-control`
* `left-shift`
* `right-shift`
* `left-menu`
* `right-menu`


=== Actors 

Actors是View事件的处理函数。 它们由`actors` facet引用的自由格式对象（未提供原型）定义。 所有Actors都具有相同的规格块。

*语法*
----
on-<event>: func [face [object!] event [event!]]

<event> : any valid event name (from above table)
face    : face object which receives the event
event   : event value.
----
除了GUI事件之外，还可以定义一个`on-create`的actor，当第一次显示face时，就会在系统资源被分配之前被调用。 与其他actor不同，`on-create`只有一个参数`face`。

*返回值*
----
'stop : exit the event loop.
'done : stops the event from flowing to the next face.
----
其他返回值无效。

=== 事件流

事件通常在特定屏幕位置生成，并分配给最接近的正面。 然而，事件是在祖先层级中从一个face到另一个在两个方向上通常被称为：

* 事件*捕获*: 事件从窗口面朝下到事件发生的正面。 对于每个face，生成一个`detect`事件，并且如果提供了相应的处理程序。

* 事件*冒泡*: 事件前面到父窗口。 对于每个face，调用本地事件处理程序。

image::event-flow.png[Event flow,align="center"]

典型事件流程：

. A click event is generated on the button, global handlers are processed (see next section).
. Event capturing stage starts:
.. The window gets the event first, its `on-detect` handler gets called.
.. The panel gets the event next. Panel's `on-detect` handler gets called.
.. The button gets the event last. Button's `on-detect` gets called.
. Event bubbling stage starts:
.. The button gets the event first, its `on-click` handler gets called.
.. The panel gets the event next. Panel's `on-click` handler gets called.
.. The window gets the event last, its `on-click` handler gets called.

注意：

* 通过从任何事件处理程序返回`done`来实现事件取消。
* 由于性能原因，默认情况下未启用事件捕获。 设置`system/view/capture?: yes`启用它。

=== 全局事件处理器

在进入事件流程之前，可以使用所谓的“全局事件处理程序”来实现特定的预处理。 提供以下API用于添加和删除它们。

==== insert-event-func

*语法*
----
insert-event-func <handler>

<handler> : a handler function or block of code for pre-processing event(s).

Handler's function specification: func [face [object!] event [event!]]
----    
*返回值*
----
新添加的处理函数（function!）。
----    
*描述*

安装一个全局处理函数，它可以在事件到达处理程序之前进行事先处理。 所有全局处理程序在每个事件上被调用，因此处理器主体代码需要优化速度和内存使用。 如果一个块作为参数提供，它将使用`function`构造函数转换为一个函数。

处理函数的返回值：

* `none`  : 事件可以由其他处理程序处理（none!）。
* `'done` : 其他全局处理程序将被跳过，但事件会传播到子窗口（word!）。
* `'stop` : 退出事件循环（word!）。

返回对处理程序函数的引用，如果需要稍后删除，则应该保存它。

==== remove-event-func

*语法*
----
remove-event-func <handler>

<handler> : a previously installed event handler function.
----
*描述*

通过从内部列表中删除先前安装的全局事件处理程序来禁用它。

== System/view object anchor:system-view-object[]

[cols="1, 4", options="header"]
|===
|Word| Description
|`screens`| List of screen faces representing connected displays.
|`event-port`| _reserved for future use_
|`metrics`| _reserved for future use_
|`platform`| View engine low-level platform code (includes backend code).
|`VID`| VID processing code.
|`handlers`| List of global event handlers
|`reactors`| Internal associative table for reactive faces and their action blocks.
|`evt-names`| Internal table for event to actor names conversion.
|`init`| View engine initialization function, can be called by user if required.
|`awake`| Main high-level events entry point function.
|`capturing?`| `yes` = enables event capturing stage and `detect` events generation (default to `no`).
|`auto-sync?`| `yes` = realtime faces updates (default), `no` = deferred faces updates.
|`debug?`| `yes` = output verbose logs of View internal events (default to `no`).
|`silent?`| `yes` = do not report VID or Draw dialects processing errors (default to `no`).
|===


== 引入View组件

*编译*默认情况下不包含View组件。 要包括它，主Red脚本必须使用`Needs`字段来声明头中的依赖关系。
----
Red [
    Needs: 'View
]
----
注意：
使用`red`二进制自动生成的控制台将在可用的平台上包含View组件，因此在这些控制台运行的用户脚本中不需要`Needs`头字段。

== 额外的函数

[cols="1, 4", options="header"]
|===

|函数 | 描述
|*view*| Render on screen a window from a face tree or a block of VID code. Enters an event loop unless `/no-wait` *refinement* is used.
|*unview*| Destroy one or more windows.
|*layout*| Convert a block of VID code into a face tree.
|*center&#8209;face*| Center a face relatively to its parent.
|*dump&#8209;face*| Output a compact description of a face tree structure (debugging purpose).
|*do&#8209;actor*| Evaluate a face actor manually.
|*do&#8209;events*| Launch an event loop (optionally just process pending events and return).
|*draw*| Render a Draw dialect block onto an image.
|*to&#8209;image*| Convert any rendered face to an image.
|*size&#8209;text*| Measure the size in pixels of a text in a face (taking the selected font into account).
|===


_待补：_

* 菜单face规范
* image!数据类型描述
